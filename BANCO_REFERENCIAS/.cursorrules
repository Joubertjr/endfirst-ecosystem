# Cursor Rules - Banco de Refer√™ncias

## üìã Vis√£o Geral do Projeto

Sistema de gest√£o de conhecimento com RAG (Retrieval-Augmented Generation) usando Google Gemini File Search API. Plataforma universal de Banco de Refer√™ncias.

**Stack Principal:**
- Backend: Python 3.12+ + FastAPI 0.115+
- Database: PostgreSQL 16 (Docker)
- Vector DB: Google File Search (OBRIGAT√ìRIO)
- Frontend: Next.js 15 (Fase 3)
- Containeriza√ß√£o: Docker + Docker Compose (OBRIGAT√ìRIO)

---

## üêç Python (Backend) - Regras e Padr√µes

### Estrutura de C√≥digo

1. **Organiza√ß√£o de Arquivos**
   - M√°ximo 300-500 linhas por arquivo
   - Estrutura: `app/api/`, `app/services/`, `app/repositories/`, `app/models/`, `app/schemas/`
   - Evitar "God Objects" - um arquivo n√£o deve fazer tudo

2. **Type Hints Obrigat√≥rios**
   ```python
   async def process_document(file_id: str, filename: str) -> dict[str, Any]:
       """Processa documento e retorna resultado."""
       pass
   ```
   - Sempre usar type hints em fun√ß√µes p√∫blicas
   - Usar `typing` para tipos complexos (Dict, List, Optional, Union)
   - Retornar tipos expl√≠citos, n√£o `Any` quando poss√≠vel

3. **Docstrings**
   ```python
   async def analyze_document(document_id: UUID) -> DocumentResponse:
       """
       Analisa documento segundo playbooks.
       
       Args:
           document_id: Identificador √∫nico do documento
           
       Returns:
           DocumentResponse com resultados da an√°lise
           
       Raises:
           DocumentNotFoundError: Se document_id n√£o existe
       """
   ```
   - Sempre documentar fun√ß√µes p√∫blicas
   - Incluir Args, Returns, Raises quando aplic√°vel

4. **Tratamento de Erros**
   ```python
   try:
       result = await process_data()
   except SpecificException as e:
       logger.error(f"Erro ao processar: {e}", exc_info=True)
       raise HTTPException(status_code=404, detail=str(e))
   except Exception as e:
       logger.exception("Erro inesperado")
       raise
   ```
   - Capturar exce√ß√µes espec√≠ficas primeiro
   - Sempre logar erros com contexto
   - Usar exce√ß√µes HTTP do FastAPI quando apropriado

5. **Imports**
   ```python
   # 1. Standard library
   import os
   from typing import Dict, Any, Optional
   
   # 2. Third-party
   from fastapi import FastAPI, Depends
   from google import genai
   
   # 3. Local
   from app.services import document_service
   ```
   - Organizar em 3 grupos: stdlib, third-party, local
   - Nunca importar dentro de fun√ß√µes (exceto para evitar circular imports)

6. **Banco de Dados (SQLAlchemy async)**
   ```python
   async def get_document(db: AsyncSession, document_id: UUID) -> Optional[Document]:
       """Recupera documento do banco."""
       result = await db.execute(
           select(Document).where(Document.id == document_id)
       )
       return result.scalar_one_or_none()
   ```
   - Sempre usar async/await com SQLAlchemy async
   - Usar `AsyncSession` do SQLAlchemy
   - Validar inputs antes de queries
   - Usar `Depends(get_db)` para inje√ß√£o de depend√™ncia

7. **Repository Pattern**
   - Repositories acessam dados (PostgreSQL, Google File Search)
   - Services cont√™m l√≥gica de neg√≥cio
   - Endpoints apenas chamam services

8. **Fun√ß√µes e Complexidade**
   - M√°ximo 20-30 linhas por fun√ß√£o (ideal)
   - Complexidade ciclom√°tica < 10 (m√°ximo 15)
   - Uma fun√ß√£o = uma responsabilidade
   - Extrair l√≥gica repetida para fun√ß√µes auxiliares

9. **Nomenclatura**
   - Fun√ß√µes: `snake_case` (ex: `analyze_document`)
   - Constantes: `UPPER_SNAKE_CASE` (ex: `MAX_RETRIES`)
   - Classes: `PascalCase` (ex: `DocumentService`)
   - Privadas: prefixo `_` (ex: `_internal_helper`)

---

## ‚öõÔ∏è TypeScript/Next.js (Frontend - Fase 3) - Regras e Padr√µes

### Estrutura de Componentes

1. **Next.js 15 App Router**
   - Usar Server Components por padr√£o
   - Client Components apenas quando necess√°rio (interatividade)
   - Server Actions para mutations

2. **TypeScript Strict**
   ```typescript
   interface Document {
     id: string
     filename: string
     size: number
     upload_date: string
   }
   
   const loadDocuments = async (): Promise<Document[]> => {
     const res = await fetch('/api/v1/documents')
     return res.json()
   }
   ```
   - Sempre definir interfaces/types
   - Evitar `any` - usar `unknown` se necess√°rio

3. **Hooks e Estado**
   ```typescript
   const [documents, setDocuments] = useState<Document[]>([])
   const [loading, setLoading] = useState<boolean>(false)
   
   useEffect(() => {
     loadDocuments()
   }, [])
   ```
   - Agrupar estados relacionados
   - Sempre incluir cleanup em useEffect com timers

4. **Tratamento de Erros**
   ```typescript
   try {
     const result = await apiCall()
     setData(result)
   } catch (err: unknown) {
     if (err instanceof Error) {
       setError(err.message)
     }
   }
   ```
   - Sempre tratar erros em async/await
   - Mostrar mensagens amig√°veis ao usu√°rio

---

## üèóÔ∏è Arquitetura

### Padr√µes de Design

1. **Repository Pattern**
   - Abstra√ß√£o do acesso a dados
   - Isolamento da l√≥gica de neg√≥cio

2. **Service Layer**
   - L√≥gica de neg√≥cio isolada
   - Orquestra√ß√£o de opera√ß√µes

3. **DTO Pattern (Pydantic)**
   - Schemas para valida√ß√£o
   - Separa√ß√£o request/response

4. **Dependency Injection**
   - FastAPI `Depends` nativo
   - Testabilidade

---

## üß™ Testes

### Backend (Python)

- Usar `pytest` para testes
- Seguir padr√£o AAA: Arrange, Act, Assert
- Cobertura m√≠nima: 80%

### Frontend (TypeScript)

- Usar `Vitest` ou `Jest`
- Testar comportamento, n√£o implementa√ß√£o
- Cobertura m√≠nima: 80%

---

## üîí Seguran√ßa

1. **Valida√ß√£o de Input**
   - Sempre validar com Pydantic
   - Validar tamanho de arquivo, tipos MIME

2. **SQL Injection Prevention**
   - Sempre usar SQLAlchemy ORM
   - Nunca construir queries com f-strings

3. **Secrets e Environment Variables**
   - Nunca commitar `.env`
   - Usar `.env.example` com valores fict√≠cios
   - Validar vari√°veis obrigat√≥rias na inicializa√ß√£o

---

## üìù Documenta√ß√£o

1. **Docstrings**
   - Documentar todas as fun√ß√µes p√∫blicas
   - Incluir exemplos quando √∫til

2. **Coment√°rios**
   - Comentar "por qu√™", n√£o "o qu√™"
   - Evitar coment√°rios √≥bvios

---

## ‚úÖ Checklist Antes de Commitar

- [ ] C√≥digo segue padr√µes de formata√ß√£o
- [ ] Type hints/types completos
- [ ] Tratamento de erros implementado
- [ ] Testes passando (se existirem)
- [ ] Sem c√≥digo duplicado
- [ ] Fun√ß√µes <30 linhas
- [ ] Documenta√ß√£o atualizada

---

**√öltima atualiza√ß√£o**: 2025-12-16
**Vers√£o**: 1.0.0

